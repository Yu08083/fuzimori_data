<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>+perion Web</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Noto+Sans+JP:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-body: #0a0a0a;
            --bg-card: #141414;
            --bg-input: #1a1a1a;
            --accent: #00e5ff;
            --text-main: #ffffff;
            --text-sub: #b0b0b0;
            --border: #333333;
            --shadow: rgba(0, 229, 255, 0.15);
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            text-align: center;
        }

        .header-area {
            margin-bottom: 30px;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .app-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 32px;
            color: var(--accent);
            text-shadow: 0 0 15px var(--shadow);
            margin: 0;
            letter-spacing: 2px;
        }

        textarea {
            width: 100%;
            height: 150px;
            background-color: var(--bg-input);
            color: var(--text-main);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 15px;
            font-size: 14px;
            box-sizing: border-box;
            resize: vertical;
            outline: none;
            transition: border-color 0.3s;
        }

        textarea:focus {
            border-color: var(--accent);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin: 20px auto;
            text-align: left;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group label {
            width: 80px;
            font-weight: bold;
            color: var(--text-sub);
            font-size: 14px;
        }

        .input-group input {
            flex: 1;
            background-color: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: 4px;
            outline: none;
        }
        
        .input-group input:focus {
            border-color: var(--accent);
        }

        .controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
        }

        button {
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
        }

        button:active { transform: translateY(1px); }

        .btn-main {
            background-color: var(--accent);
            color: #000;
            box-shadow: 0 0 10px var(--shadow);
        }
        .btn-main:hover { background-color: #33efff; box-shadow: 0 0 20px var(--shadow); }

        .btn-sub {
            background-color: transparent;
            border: 1px solid var(--border);
            color: var(--text-sub);
        }
        .btn-sub:hover { border-color: var(--text-main); color: var(--text-main); }

        .btn-discord {
            background-color: #5865F2;
            color: white;
        }
        .btn-discord:hover { background-color: #4752c4; }

        .btn-danger {
            background-color: transparent;
            border: 1px solid #ff4444;
            color: #ff4444;
        }
        .btn-danger:hover { background-color: #ff4444; color: white; }

        .status-msg {
            height: 20px;
            color: var(--accent);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            padding: 10px;
        }

        .qr-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            transition: transform 0.2s, border-color 0.2s;
            cursor: pointer;
        }

        .qr-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }

        .qr-card img {
            width: 100%;
            height: auto;
            border-radius: 4px;
            display: block;
        }

        .qr-name {
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-main);
            word-break: break-all;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-img {
            max-width: 90%;
            max-height: 90%;
            border: 2px solid var(--accent);
            box-shadow: 0 0 30px var(--shadow);
            border-radius: 8px;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            color: var(--accent);
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
        }

    </style>
</head>
<body>

<div class="container">
    <div class="header-area">
        <h1 class="app-title">+ PERION // WEB</h1>
    </div>

    <textarea id="inputText" placeholder="Hyperionã§å‡ºåŠ›ã—ãŸå¼ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>

    <div class="settings-grid">
        <div class="input-group">
            <label>Webhook</label>
            <input type="text" id="discordWebhook" placeholder="Discord Webhook URL">
        </div>
        <div class="input-group">
            <label>Message</label>
            <input type="text" id="discordMessage" value="QR ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ï¼">
        </div>
    </div>

    <div class="controls">
        <button class="btn-main" onclick="startGeneration()">âš¡ GENERATE QR</button>
        <button class="btn-sub" onclick="downloadZip()">â¬‡ DOWNLOAD ZIP</button>
        <button class="btn-discord" onclick="sendToDiscord()">ðŸ“¤ SEND DISCORD</button>
        <button class="btn-danger" onclick="resetAll()">âœ– RESET</button>
    </div>

    <div id="statusMsg" class="status-msg"></div>

    <div id="outputContainer" class="qr-grid"></div>
</div>

<div id="loading" class="loading-overlay">PROCESSING...</div>

<div id="qrModal" class="modal" onclick="closeModal()">
    <img class="modal-img" id="modalImg">
</div>

<script>
    const LOGO_URL = "https://raw.githubusercontent.com/Yu08083/fuzimori_data/main/logo.png";
    const RESOLUTION_SCALE = 4;
    
    let generatedFiles = []; 
    let logoImage = null;

    window.onload = () => {
        logoImage = new Image();
        logoImage.crossOrigin = "Anonymous";
        logoImage.src = LOGO_URL;
    };

    async function startGeneration() {
        const text = document.getElementById('inputText').value;
        const statusDiv = document.getElementById('statusMsg');
        const container = document.getElementById('outputContainer');
        const loading = document.getElementById('loading');

        container.innerHTML = "";
        generatedFiles = [];
        statusDiv.innerText = "";

        const regex = /\b([aAb][A-Za-z0-9]{5})_?\s*([^\s\+\)]+)/g;
        let matches = [...text.matchAll(regex)];

        const seen = new Set();
        const tokens = [];

        for (const m of matches) {
            let code = m[1];
            if (code.endsWith('_')) code = code.slice(0, -1);
            const name = m[2];
            
            if (!seen.has(code)) {
                seen.add(code);
                tokens.push({ code, name });
            }
        }

        if (tokens.length === 0) {
            statusDiv.innerText = "No Data Found";
            return;
        }

        loading.style.display = "flex";

        try {
            const msgRegex = /[\s\)](\S+)\s+(?:ã‚¢ãƒ³ãƒ†ãƒŠ:|é ­:|ä½“æ ¼:)/; 
            const msgMatch = text.match(msgRegex);
            
            if (msgMatch) {
                const startWord = msgMatch[1];
                const lastIndex = text.lastIndexOf(startWord);
                if (lastIndex !== -1) {
                    const extracted = text.substring(lastIndex).trim();
                    if(extracted) {
                        document.getElementById('discordMessage').value = extracted;
                    }
                }
            }
        } catch(e) {}

        statusDiv.innerText = `${tokens.length} Generated`;

        for (const token of tokens) {
            try {
                const dataUrl = await createHighResQR(token.code, token.name);
                generatedFiles.push({ ...token, dataUrl });

                const div = document.createElement('div');
                div.className = 'qr-card';
                div.onclick = () => openModal(dataUrl);
                
                const img = document.createElement('img');
                img.src = dataUrl;
                
                const label = document.createElement('div');
                label.className = 'qr-name';
                label.innerText = token.name;

                div.appendChild(img);
                div.appendChild(label);
                container.appendChild(div);
            } catch (e) {}
        }

        loading.style.display = "none";
    }

    function createHighResQR(code, name) {
        return new Promise((resolve, reject) => {
            const tempDiv = document.createElement('div');
            const baseSize = 256;
            
            const qrObj = new QRCode(tempDiv, {
                text: code,
                width: baseSize * RESOLUTION_SCALE,
                height: baseSize * RESOLUTION_SCALE,
                correctLevel: QRCode.CorrectLevel.H
            });

            setTimeout(() => {
                const sourceCanvas = tempDiv.querySelector('canvas');
                const imgFallback = tempDiv.querySelector('img');
                
                if (!sourceCanvas && !imgFallback) { reject(); return; }

                const process = (srcElement) => {
                    const size = baseSize * RESOLUTION_SCALE;
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    const fontSize = Math.floor(size * 0.055); 
                    const padding = 50 * (RESOLUTION_SCALE / 2);
                    const gapQrText = 20 * (RESOLUTION_SCALE / 2);

                    ctx.font = `bold ${fontSize}px "Noto Sans JP", sans-serif`;
                    const labelText = `${name} (${code})`;
                    const textMetrics = ctx.measureText(labelText);
                    const textW = textMetrics.width;
                    const textH = fontSize * 1.2;

                    const contentH = padding + size + gapQrText + textH + padding;
                    const contentW = padding + Math.max(size, textW) + padding;
                    const finalSize = Math.max(contentH, contentW);

                    canvas.width = finalSize;
                    canvas.height = finalSize;

                    ctx.fillStyle = "white";
                    ctx.fillRect(0, 0, finalSize, finalSize);

                    const totalH = size + gapQrText + textH;
                    const startY = (finalSize - totalH) / 2;
                    const qrX = (finalSize - size) / 2;
                    const qrY = startY;

                    ctx.drawImage(srcElement, qrX, qrY, size, size);

                    const frameGap = 10 * RESOLUTION_SCALE;
                    const x1 = qrX - frameGap;
                    const y1 = qrY - frameGap;
                    const x2 = qrX + size + frameGap;
                    const y2 = qrY + size + frameGap;
                    const lineLen = size / 4;
                    const lineThick = 4 * RESOLUTION_SCALE;

                    ctx.strokeStyle = "black";
                    ctx.lineWidth = lineThick;
                    ctx.lineCap = "square";

                    ctx.beginPath();
                    ctx.moveTo(x1, y1 + lineLen); ctx.lineTo(x1, y1); ctx.lineTo(x1 + lineLen, y1);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(x2 - lineLen, y1); ctx.lineTo(x2, y1); ctx.lineTo(x2, y1 + lineLen);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(x1, y2 - lineLen); ctx.lineTo(x1, y2); ctx.lineTo(x1 + lineLen, y2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(x2 - lineLen, y2); ctx.lineTo(x2, y2); ctx.lineTo(x2, y2 - lineLen);
                    ctx.stroke();

                    if (logoImage && logoImage.complete && logoImage.naturalWidth !== 0) {
                        const logoSize = Math.floor(size * 0.25);
                        const logoX = qrX + (size - logoSize) / 2;
                        const logoY = qrY + (size - logoSize) / 2;
                        ctx.drawImage(logoImage, logoX, logoY, logoSize, logoSize);
                    }

                    ctx.fillStyle = "black";
                    ctx.textAlign = "center";
                    ctx.font = `bold ${fontSize}px "Noto Sans JP", sans-serif`;
                    
                    const textX = finalSize / 2;
                    const textY = qrY + size + gapQrText + fontSize;
                    ctx.fillText(labelText, textX, textY);

                    resolve(canvas.toDataURL("image/png"));
                };

                if (sourceCanvas) {
                    process(sourceCanvas);
                } else {
                    if (imgFallback.complete) process(imgFallback);
                    else imgFallback.onload = () => process(imgFallback);
                }
            }, 100);
        });
    }

    async function downloadZip() {
        if (!generatedFiles.length) return;
        
        const zip = new JSZip();
        const inputText = document.getElementById('inputText').value;
        
        let mainName = "qr_outputs";
        const nameMatch = inputText.match(/(?:^|\s)(\S+)\s+(?:ã‚¢ãƒ³ãƒ†ãƒŠ:|é ­:|ä½“æ ¼:)/);
        if (nameMatch) mainName = nameMatch[1].replace(/[\\/:*?"<>|]/g, '');

        zip.file(`${mainName}_root.txt`, inputText);

        generatedFiles.forEach(f => {
            const safeName = f.name.replace(/[\\/:*?"<>|]/g, '');
            const base64 = f.dataUrl.split(',')[1];
            zip.file(`${safeName}(${f.code}).png`, base64, {base64: true});
        });

        const blob = await zip.generateAsync({type:"blob"});
        saveAs(blob, `${mainName}_qr.zip`);
    }

    async function sendToDiscord() {
        if (!generatedFiles.length) return;
        const url = document.getElementById('discordWebhook').value;
        if (!url) return;

        const msg = document.getElementById('discordMessage').value;
        const statusDiv = document.getElementById('statusMsg');

        const zip = new JSZip();
        const inputText = document.getElementById('inputText').value;
        let mainName = "qr_outputs";
        const nameMatch = inputText.match(/(?:^|\s)(\S+)\s+(?:ã‚¢ãƒ³ãƒ†ãƒŠ:|é ­:|ä½“æ ¼:)/);
        if (nameMatch) mainName = nameMatch[1].replace(/[\\/:*?"<>|]/g, '');

        zip.file(`${mainName}_root.txt`, inputText);
        generatedFiles.forEach(f => {
            const safeName = f.name.replace(/[\\/:*?"<>|]/g, '');
            const base64 = f.dataUrl.split(',')[1];
            zip.file(`${safeName}(${f.code}).png`, base64, {base64: true});
        });
        const blob = await zip.generateAsync({type:"blob"});

        const formData = new FormData();
        formData.append("content", msg);
        formData.append("file", blob, `${mainName}_qr.zip`);

        statusDiv.innerText = "Sending...";

        try {
            const res = await fetch(url, { method: 'POST', body: formData });
            if (res.ok || res.status === 204) {
                alert("Success");
                statusDiv.innerText = "Done";
            } else {
                statusDiv.innerText = `Error: ${res.status}`;
            }
        } catch (e) {
            statusDiv.innerText = "Connection Error";
            alert("Connection Error");
        }
    }

    function resetAll() {
        document.getElementById('inputText').value = "";
        document.getElementById('outputContainer').innerHTML = "";
        document.getElementById('statusMsg').innerText = "";
        generatedFiles = [];
    }

    function openModal(src) {
        document.getElementById('qrModal').style.display = 'flex';
        document.getElementById('modalImg').src = src;
    }
    function closeModal() {
        document.getElementById('qrModal').style.display = 'none';
    }

</script>
</body>
</html>